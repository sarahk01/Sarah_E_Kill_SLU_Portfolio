WITH Demographics AS 
(
    SELECT DISTINCT
        customer_id,
        MAX((CASE WHEN (demographic_name = 'Primary Business') THEN val_text ELSE null END)) T_Primary_Business,
        MAX((CASE WHEN (demographic_name = 'Sales Volume') THEN val_text ELSE null END)) T_Sales_Volume,
        MAX((CASE WHEN (demographic_name = 'Business') THEN val_text ELSE null END)) M_Primary_Business,
	MAX((CASE WHEN (demographic_name = 'Primary Business') THEN val_text ELSE null END)) S_Primary_Business,
	MAX((CASE WHEN (demographic_name = 'Business') THEN val_text ELSE null END)) I_Primary_Business,
        MAX((CASE WHEN (demographic_name = 'Primary Job Function') THEN val_text ELSE null END)) M_Primary_Job_Function,
	MAX((CASE WHEN (demographic_name = 'Job Function') THEN val_text ELSE null END)) S_Primary_Job_Function,
        MAX((CASE WHEN (demographic_name = 'Job Title') THEN val_text ELSE null END)) I_Primary_Job_Function,
        MAX((CASE WHEN (demographic_name = 'Business Activity') THEN val_text ELSE null END)) A_Primary_Business,
        MAX((CASE WHEN (demographic_name = 'Function') THEN val_text ELSE null END)) A_Primary_Job_Function,
        MAX((CASE WHEN (demographic_name = 'Primary Business') THEN val_text ELSE null END)) TA_Primary_Business,
        MAX((CASE WHEN (demographic_name = 'Sales Volume') THEN val_text ELSE null END)) TA_Sales_Volume,
        MAX((CASE WHEN (demographic_name = 'US Travel Spend') THEN val_text ELSE null END)) BU_Travel_Cost,
        MAX((CASE WHEN (demographic_name = 'US Travel Involvement') THEN val_text ELSE null END)) BU_Involvment,
        MAX((CASE WHEN (demographic_name = 'US Primary Job Function') THEN val_text ELSE null END)) BU_Primary_Job_Function,
        MAX((CASE WHEN (demographic_name = 'US Primary Business') THEN val_text ELSE null END)) BU_Primary_Business,
        MAX((CASE WHEN (demographic_name = 'UK Annual Business Travel Spend') THEN val_text ELSE null END)) BK_Travel_Cost,
        MAX((CASE WHEN (demographic_name = 'UK Business Travel Involvement') THEN val_text ELSE null END)) BK_Involvment,
        MAX((CASE WHEN (demographic_name = 'UK Primary Job Function') THEN val_text ELSE null END)) BK_Primary_Job_Function,
        MAX((CASE WHEN (demographic_name = 'UK Business Sector') THEN val_text ELSE null END)) BK_Primary_Business
      
  
    FROM
            (
            SELECT
                customer_id,
                demographic_name,
                array_to_string(array_agg(dem.value_text), ',') val_text
            FROM
                omeda_customer_demographic cdem
            LEFT JOIN 
                omeda_demographic dem ON ((cdem.demographic_id = dem.demographic_id) AND (cdem.value_id = dem.value_id))
            WHERE
                demographic_name = 'Primary Business' OR demographic_name = 'Sales Volume' OR demographic_name = 'Business' 
                OR demographic_name = 'Primary Job Function' OR demographic_name = 'Primary Business' OR demographic_name = 'Job Function' 
                OR demographic_name = 'Business' OR  demographic_name = 'Job Title'OR demographic_name = 'Business Activity' OR  demographic_name = 'Function' 
                OR demographic_name = 'Primary Business' OR  demographic_name = 'Sales Volume' OR demographic_name = 'US Annual Business Travel Spend' 
                OR demographic_name = 'US Business Travel Involvement' OR demographic_name = 'US Primary Job Function' OR demographic_name = 'US Primary Business'
                OR demographic_name = 'UK Annual Business Travel Spend' OR demographic_name = 'UK Business Travel Involvement' OR demographic_name = 'UK Primary Job Function'
                OR demographic_name = 'UK Business Sector'
            GROUP BY 1,2
            ORDER BY 1
            )
    GROUP BY 1
)

SELECT
    ddu.customer_id,
    ddu.deployment_name as product_name,
    ddu.name as deployment_actual_name,
    'Newsletter' as product_type_name,
    NULL as product_version_type,
    ddu.send_dt as product_original_order,
    twd.T_Primary_Business,
    twd.T_Sales_Volume,
    twd.M_Primary_Business,
    twd.M_Primary_Job_Function,
    twd.S_Primary_Business,
    twd.S_Primary_Job_Function,
    twd.I_Primary_Business,
    twd.I_Primary_Job_Function,
    twd.A_Primary_Business,
    twd.A_Primary_Job_Function,
    twd.TA_Primary_Business,
    twd.TA_Sales_Volume,
    twd.BU_Travel_Cost,
    twd.BU_Involvment,
    twd.BU_Primary_Job_Function,
    twd.BU_Primary_Business,
    twd.BK_Travel_Cost,
    twd.BK_Involvment,
    twd.BK_Primary_Job_Function,
    twd.BK_Primary_Business,
    country_code,
    CASE 
        WHEN country_code = 'USA' AND status = 'Primary' THEN 'United States'
        WHEN country_code = 'CAN'  AND status = 'Primary' THEN 'Canada'
        WHEN country_code IN ('ATG', 'AIA', 'ABW', 'BRB', 'BLZ', 'CRI', 'CUB', 'DMA', 'DOM', 'GRD', 'GTM', 'HND', 'HTI', 'JAM', 'KNA', 'LCA', 'MSR', 'NIC', 'PAN', 'SLV', 'TTO', 'VCT', 'BES', 'BMU', 'CUW', 'GLP', 'MAF', 'MTQ', 'PRI', 'SXM', 'TCA', 'VGB', 'VIR', 'MEX', 'ANT', 'BHS', 'BLM', 'CYM')  AND status = 'Primary' THEN 'Caribbean/Central America'
        WHEN country_code IN ('ARE', 'BHR', 'EGY', 'ISR', 'IRQ', 'IRN', 'JOR', 'KWT', 'LBN', 'OMN', 'QAT', 'SAU', 'SYR', 'YEM', 'UAE')  AND status = 'Primary' THEN 'Middle East'
        WHEN country_code IN ('AUS', 'NZL', 'FJI', 'GUM', 'PNG', 'SLB', 'TON', 'VUT', 'WSM', 'ASM', 'COK', 'NCL', 'PYF', 'TUV', 'UMI', 'AU', 'KIR', 'MNP', 'NZ')  AND status = 'Primary' THEN 'Pacific Rim'
        WHEN country_code IN ('DZA', 'AGO', 'BEN', 'BWA', 'BFA', 'BDI', 'CMR', 'CPV', 'CAF', 'TCD', 'COM', 'COG', 'COD', 'DJI', 'EGY', 'GNQ', 'ERI', 'SWZ', 'ETH', 'GAB', 'GMB', 'GHA', 'GIN', 'GNB', 'CIV', 'KEN', 'LSO', 'LBR', 'LBY', 'MDG', 'MWI', 'MLI', 'MRT', 'MUS', 'MYT', 'MAR', 'MOZ', 'NAM', 'NER', 'NGA', 'RWA', 'STP', 'SEN', 'SYC', 'SLE', 'SOM', 'ZAF', 'SSD', 'SDN', 'TZA', 'TGO', 'TUN', 'UGA', 'ESH', 'ZMB', 'ZWE', 'IOT', 'REU', 'SHN')  AND status = 'Primary' THEN 'Africa'
        WHEN country_code IN ('CHN', 'IND', 'IDN', 'JPN', 'KOR', 'MYS', 'PHL', 'SGP', 'THA', 'VNM', 'HKG', 'TWN', 'BRN', 'KHM', 'LAO', 'MMR', 'PAK', 'BGD', 'NPL', 'LKA', 'MDV', 'BTN', 'TLS', 'AFG', 'MAC', 'MNG', 'PRK', 'UZB')  AND status = 'Primary' THEN 'Asia'
        WHEN country_code IN ('ALB', 'AND', 'ARM', 'AUT', 'AZE', 'BLR', 'BEL', 'BIH', 'BGR', 'HRV', 'CYP', 'CZE', 'DNK', 'EST', 'FIN', 'FRA', 'GEO', 'DEU', 'GRC', 'HUN', 'ISL', 'IRL', 'ITA', 'KAZ', 'LVA', 'LIE', 'LTU', 'LUX', 'MLT', 'MCO', 'MDA', 'MNE', 'NLD', 'MKD', 'NOR', 'POL', 'PRT', 'ROU', 'RUS', 'SMR', 'SRB', 'SVK', 'SVN', 'ESP', 'SWE', 'CHE', 'TUR', 'UKR', 'GBR', 'VAT', 'ALA', 'GGY', 'GIB', 'IMN', 'JEY', 'CH', 'GB', 'GRB', 'SK', 'UK', 'uk')  AND status = 'Primary' THEN 'Europe'
        WHEN country_code IN ('ARG', 'BOL', 'BRA', 'CHL', 'COL', 'ECU', 'GUY', 'PRY', 'PER', 'SUR', 'URY', 'VEN', 'FLK', 'CO')  AND status = 'Primary' THEN 'South America'
        WHEN country_code IN ('ATA', 'ZZZ')  AND status = 'Primary' THEN 'Other'
        ELSE 'Other'
    END geographic_area,
    CASE 
        WHEN region_code = 'AL' THEN 'Alabama'
        WHEN region_code = 'AK' THEN 'Alaska'
        WHEN region_code = 'AZ' THEN 'Arizona'
        WHEN region_code = 'AR' THEN 'Arkansas'
        WHEN region_code = 'CA' THEN 'California'
        WHEN region_code = 'CO' THEN 'Colorado'
        WHEN region_code = 'CT' THEN 'Connecticut'
        WHEN region_code = 'DC' THEN 'D.C.'
        WHEN region_code = 'DE' THEN 'Delaware'
        WHEN region_code = 'FL' THEN 'Florida'
        WHEN region_code = 'GA' THEN 'Georgia'
        WHEN region_code = 'HI' THEN 'Hawaii'
        WHEN region_code = 'ID' THEN 'Idaho'
        WHEN region_code = 'IL' THEN 'Illinois'
        WHEN region_code = 'IN' THEN 'Indiana'
        WHEN region_code = 'IA' THEN 'Iowa'
        WHEN region_code = 'KS' THEN 'Kansas'
        WHEN region_code = 'KY' THEN 'Kentucky'
        WHEN region_code = 'LA' THEN 'Louisiana'
        WHEN region_code = 'ME' THEN 'Maine'
        WHEN region_code = 'MD' THEN 'Maryland'
        WHEN region_code = 'MA' THEN 'Massachusetts'
        WHEN region_code = 'MI' THEN 'Michigan'
        WHEN region_code = 'MN' THEN 'Minnesota'
        WHEN region_code = 'MS' THEN 'Mississippi'
        WHEN region_code = 'MO' THEN 'Missouri'
        WHEN region_code = 'MT' THEN 'Montana'
        WHEN region_code = 'NE' THEN 'Nebraska'
        WHEN region_code = 'NV' THEN 'Nevada'
        WHEN region_code = 'NH' THEN 'New Hampshire'
        WHEN region_code = 'NJ' THEN 'New Jersey'
        WHEN region_code = 'NM' THEN 'New Mexico'
        WHEN region_code = 'NY' THEN 'New York'
        WHEN region_code = 'NC' THEN 'North Carolina'
        WHEN region_code = 'ND' THEN 'North Dakota'
        WHEN region_code = 'OH' THEN 'Ohio'
        WHEN region_code = 'OK' THEN 'Oklahoma'
        WHEN region_code = 'OR' THEN 'Oregon'
        WHEN region_code = 'PA' THEN 'Pennsylvania'
        WHEN region_code = 'RI' THEN 'Rhode Island'
        WHEN region_code = 'SC' THEN 'South Carolina'
        WHEN region_code = 'SD' THEN 'South Dakota'
        WHEN region_code = 'TN' THEN 'Tennessee'
        WHEN region_code = 'TX' THEN 'Texas'
        WHEN region_code = 'UT' THEN 'Utah'
        WHEN region_code = 'VT' THEN 'Vermont'
        WHEN region_code = 'VA' THEN 'Virginia'
        WHEN region_code = 'WA' THEN 'Washington'
        WHEN region_code = 'WV' THEN 'West Virginia'
        WHEN region_code = 'WI' THEN 'Wisconsin'
        WHEN region_code = 'WY' THEN 'Wyoming'
        ELSE 'Unknown'
    END AS state_full_name,
    CASE 
        WHEN region_code IN ('CT', 'ME', 'MA', 'NH', 'RI', 'VT', 'NJ', 'NY', 'PA') THEN 1
        ELSE 0
    END AS northeast,
    CASE 
        WHEN region_code IN ('IL', 'IN', 'IA', 'KS', 'MI', 'MN', 'MO', 'NE', 'ND', 'OH', 'SD', 'WI') THEN 1
        ELSE 0
    END AS midwest,
    CASE 
        WHEN region_code IN ('AL', 'AR', 'DC', 'DE', 'FL', 'GA', 'KY', 'LA', 'MD', 'MS', 'NC', 'OK', 'SC', 'TN', 'TX', 'VA', 'WV') THEN 1
        ELSE 0
    END AS south,
    CASE 
        WHEN region_code IN ('AK', 'AZ', 'CA', 'CO', 'HI', 'ID', 'MT', 'NV', 'NM', 'OR', 'UT', 'WA', 'WY') THEN 1
        ELSE 0
    END AS west
FROM
    daily_deployments_users_36_mnths ddu
LEFT JOIN
    Demographics twd ON twd.customer_id = ddu.customer_id
LEFT JOIN
    (SELECT * FROM omeda_customer_address WHERE status = 'Primary') oca ON oca.customer_id = ddu.customer_id
WHERE 
    send_dt BETWEEN date_trunc(current_date - interval '2' MONTH, MONTH) AND date_trunc(current_date, MONTH) - interval '1' day




UNION ALL


SELECT DISTINCT
    cph.customer_id,
    cph.product_name,
    CAST(NULL AS STRING) AS deployment_actual_name,
                cph.product_type_name,
                CASE
                    WHEN cph.product_type_name = 'Magazine' THEN product_version_type
                    ELSE null
                END as product_version_type,
                SAFE_CAST(REGEXP_REPLACE(TRIM(CAST(product_original_order AS STRING)), r'[^0-9\-]', '') AS DATE),
                twd.T_Primary_Business,
                twd.T_Sales_Volume,
                twd.M_Primary_Business,
    		twd.M_Primary_Job_Function,
    		twd.S_Primary_Business,
    		twd.S_Primary_Job_Function,
    		twd.I_Primary_Business,
    		twd.I_Primary_Job_Function,
                twd.A_Primary_Business,
                twd.A_Primary_Job_Function,
                twd.TA_Primary_Business,
                twd.TA_Sales_Volume,
                twd.BU_Travel_Cost,
                twd.BU_Involvment,
                twd.BU_Primary_Job_Function,
                twd.BU_Primary_Business,
                twd.BK_Travel_Cost,
                twd.BK_Involvment,
                twd.BK_Primary_Job_Function,
                twd.BK_Primary_Business,
                country_code,
    CASE 
        WHEN country_code = 'USA' AND status = 'Primary' THEN 'United States'
        WHEN country_code = 'CAN'  AND status = 'Primary' THEN 'Canada'
        WHEN country_code IN ('ATG', 'AIA', 'ABW', 'BRB', 'BLZ', 'CRI', 'CUB', 'DMA', 'DOM', 'GRD', 'GTM', 'HND', 'HTI', 'JAM', 'KNA', 'LCA', 'MSR', 'NIC', 'PAN', 'SLV', 'TTO', 'VCT', 'BES', 'BMU', 'CUW', 'GLP', 'MAF', 'MTQ', 'PRI', 'SXM', 'TCA', 'VGB', 'VIR', 'MEX', 'ANT', 'BHS', 'BLM', 'CYM')  AND status = 'Primary' THEN 'Caribbean/Central America'
        WHEN country_code IN ('ARE', 'BHR', 'EGY', 'ISR', 'IRQ', 'IRN', 'JOR', 'KWT', 'LBN', 'OMN', 'QAT', 'SAU', 'SYR', 'YEM', 'UAE')  AND status = 'Primary' THEN 'Middle East'
        WHEN country_code IN ('AUS', 'NZL', 'FJI', 'GUM', 'PNG', 'SLB', 'TON', 'VUT', 'WSM', 'ASM', 'COK', 'NCL', 'PYF', 'TUV', 'UMI', 'AU', 'KIR', 'MNP', 'NZ')  AND status = 'Primary' THEN 'Pacific Rim'
        WHEN country_code IN ('DZA', 'AGO', 'BEN', 'BWA', 'BFA', 'BDI', 'CMR', 'CPV', 'CAF', 'TCD', 'COM', 'COG', 'COD', 'DJI', 'EGY', 'GNQ', 'ERI', 'SWZ', 'ETH', 'GAB', 'GMB', 'GHA', 'GIN', 'GNB', 'CIV', 'KEN', 'LSO', 'LBR', 'LBY', 'MDG', 'MWI', 'MLI', 'MRT', 'MUS', 'MYT', 'MAR', 'MOZ', 'NAM', 'NER', 'NGA', 'RWA', 'STP', 'SEN', 'SYC', 'SLE', 'SOM', 'ZAF', 'SSD', 'SDN', 'TZA', 'TGO', 'TUN', 'UGA', 'ESH', 'ZMB', 'ZWE', 'IOT', 'REU', 'SHN')  AND status = 'Primary' THEN 'Africa'
        WHEN country_code IN ('CHN', 'IND', 'IDN', 'JPN', 'KOR', 'MYS', 'PHL', 'SGP', 'THA', 'VNM', 'HKG', 'TWN', 'BRN', 'KHM', 'LAO', 'MMR', 'PAK', 'BGD', 'NPL', 'LKA', 'MDV', 'BTN', 'TLS', 'AFG', 'MAC', 'MNG', 'PRK', 'UZB')  AND status = 'Primary' THEN 'Asia'
        WHEN country_code IN ('ALB', 'AND', 'ARM', 'AUT', 'AZE', 'BLR', 'BEL', 'BIH', 'BGR', 'HRV', 'CYP', 'CZE', 'DNK', 'EST', 'FIN', 'FRA', 'GEO', 'DEU', 'GRC', 'HUN', 'ISL', 'IRL', 'ITA', 'KAZ', 'LVA', 'LIE', 'LTU', 'LUX', 'MLT', 'MCO', 'MDA', 'MNE', 'NLD', 'MKD', 'NOR', 'POL', 'PRT', 'ROU', 'RUS', 'SMR', 'SRB', 'SVK', 'SVN', 'ESP', 'SWE', 'CHE', 'TUR', 'UKR', 'GBR', 'VAT', 'ALA', 'GGY', 'GIB', 'IMN', 'JEY', 'CH', 'GB', 'GRB', 'SK', 'UK', 'uk')  AND status = 'Primary' THEN 'Europe'
        WHEN country_code IN ('ARG', 'BOL', 'BRA', 'CHL', 'COL', 'ECU', 'GUY', 'PRY', 'PER', 'SUR', 'URY', 'VEN', 'FLK', 'CO')  AND status = 'Primary' THEN 'South America'
        WHEN country_code IN ('ATA', 'ZZZ')  AND status = 'Primary' THEN 'Other'
        ELSE 'Other'
    END geographic_area,
    CASE 
        WHEN region_code = 'AL' THEN 'Alabama'
        WHEN region_code = 'AK' THEN 'Alaska'
        WHEN region_code = 'AZ' THEN 'Arizona'
        WHEN region_code = 'AR' THEN 'Arkansas'
        WHEN region_code = 'CA' THEN 'California'
        WHEN region_code = 'CO' THEN 'Colorado'
        WHEN region_code = 'CT' THEN 'Connecticut'
        WHEN region_code = 'DC' THEN 'D.C.'
        WHEN region_code = 'DE' THEN 'Delaware'
        WHEN region_code = 'FL' THEN 'Florida'
        WHEN region_code = 'GA' THEN 'Georgia'
        WHEN region_code = 'HI' THEN 'Hawaii'
        WHEN region_code = 'ID' THEN 'Idaho'
        WHEN region_code = 'IL' THEN 'Illinois'
        WHEN region_code = 'IN' THEN 'Indiana'
        WHEN region_code = 'IA' THEN 'Iowa'
        WHEN region_code = 'KS' THEN 'Kansas'
        WHEN region_code = 'KY' THEN 'Kentucky'
        WHEN region_code = 'LA' THEN 'Louisiana'
        WHEN region_code = 'ME' THEN 'Maine'
        WHEN region_code = 'MD' THEN 'Maryland'
        WHEN region_code = 'MA' THEN 'Massachusetts'
        WHEN region_code = 'MI' THEN 'Michigan'
        WHEN region_code = 'MN' THEN 'Minnesota'
        WHEN region_code = 'MS' THEN 'Mississippi'
        WHEN region_code = 'MO' THEN 'Missouri'
        WHEN region_code = 'MT' THEN 'Montana'
        WHEN region_code = 'NE' THEN 'Nebraska'
        WHEN region_code = 'NV' THEN 'Nevada'
        WHEN region_code = 'NH' THEN 'New Hampshire'
        WHEN region_code = 'NJ' THEN 'New Jersey'
        WHEN region_code = 'NM' THEN 'New Mexico'
        WHEN region_code = 'NY' THEN 'New York'
        WHEN region_code = 'NC' THEN 'North Carolina'
        WHEN region_code = 'ND' THEN 'North Dakota'
        WHEN region_code = 'OH' THEN 'Ohio'
        WHEN region_code = 'OK' THEN 'Oklahoma'
        WHEN region_code = 'OR' THEN 'Oregon'
        WHEN region_code = 'PA' THEN 'Pennsylvania'
        WHEN region_code = 'RI' THEN 'Rhode Island'
        WHEN region_code = 'SC' THEN 'South Carolina'
        WHEN region_code = 'SD' THEN 'South Dakota'
        WHEN region_code = 'TN' THEN 'Tennessee'
        WHEN region_code = 'TX' THEN 'Texas'
        WHEN region_code = 'UT' THEN 'Utah'
        WHEN region_code = 'VT' THEN 'Vermont'
        WHEN region_code = 'VA' THEN 'Virginia'
        WHEN region_code = 'WA' THEN 'Washington'
        WHEN region_code = 'WV' THEN 'West Virginia'
        WHEN region_code = 'WI' THEN 'Wisconsin'
        WHEN region_code = 'WY' THEN 'Wyoming'
        ELSE 'Unknown'
    END AS state_full_name,
    CASE 
        WHEN region_code IN ('CT', 'ME', 'MA', 'NH', 'RI', 'VT', 'NJ', 'NY', 'PA') THEN 1
        ELSE 0
    END AS northeast,
    CASE 
        WHEN region_code IN ('IL', 'IN', 'IA', 'KS', 'MI', 'MN', 'MO', 'NE', 'ND', 'OH', 'SD', 'WI') THEN 1
        ELSE 0
    END AS midwest,
    CASE 
        WHEN region_code IN ('AL', 'AR', 'DC', 'DE', 'FL', 'GA', 'KY', 'LA', 'MD', 'MS', 'NC', 'OK', 'SC', 'TN', 'TX', 'VA', 'WV') THEN 1
        ELSE 0
    END AS south,
    CASE 
        WHEN region_code IN ('AK', 'AZ', 'CA', 'CO', 'HI', 'ID', 'MT', 'NV', 'NM', 'OR', 'UT', 'WA', 'WY') THEN 1
        ELSE 0
    END AS west
FROM customer_product_brand cph
                LEFT JOIN 
                    Demographics twd ON twd.customer_id = cph.customer_id
                LEFT JOIN omeda_product op ON op.product_id = cph.product_id
                LEFT JOIN (SELECT * FROM omeda_customer_address WHERE status = 'Primary') oca ON oca.customer_id = cph.customer_id
WHERE 1 = 1
                AND cph.product_type_name = 'Magazine'